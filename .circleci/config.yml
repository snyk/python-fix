version: 2.1
orbs:
  snyk: snyk/snyk@0.0.8

commands:
  install_pyenv:
    steps:
      - run:
          name: Installing pyenv
          command: |
            apt -qq update
            apt -qq install python3-pip python-pip -y &> /dev/null
            curl https://pyenv.run | $SHELL
            export PATH="/root/.pyenv/bin:$PATH"
            eval "$(pyenv init -)"
            eval "$(pyenv virtualenv-init -)"
            pyenv -v
  checkout_and_restore_cache:
    steps:
      - checkout
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "package.json" }}
  lerna_bootstrap:
    steps:
      - run:
          name: lerna bootstrap
          command: |
            ./node_modules/.bin/lerna bootstrap --no-ci --ignore-scripts
  run_lerna_test:
    steps:
      - run:
          name: npm test
          command: npm run test:ci
  run_test:
    parameters:
      package-name:
        type: string
      python_version:
        type: string
      pipenv_version:
        type: string
    steps:
      - run:
          name: pyenv install << parameters.python_version >> && lerna run test --scope << parameters.package-name >> --stream`
          command: |
            apt -qq update
            apt -qq install python3-pip python-pip -y &> /dev/null
            curl https://pyenv.run | $SHELL
            export PATH="/root/.pyenv/bin:$PATH"
            eval "$(pyenv init -)"
            eval "$(pyenv virtualenv-init -)"
            pyenv -v
            export PYTHON_VERSION_LATEST=`pyenv install --list | grep -v 'Available versions' | awk '{$1=$1};1' | grep "^$PYTHON_VERSION\.[0-9]\+$" | tail -1`
            echo $PYTHON_VERSION_LATEST
            # Install the specific release of Python if it isn't already installed
            pyenv install -s $PYTHON_VERSION_LATEST
            pyenv sh-shell $PYTHON_VERSION_LATEST
            python --version
            export PATH=$HOME/.local/bin:$PATH
            python -m pip install --user pipenv==$PIPENV_VERSION
            python -m pipenv --version
            ./node_modules/.bin/lerna run test --scope << parameters.package-name >> --stream
          environment:
            PYTHON_VERSION: << parameters.python_version >>
            PIPENV_VERSION: << parameters.pipenv_version >>
jobs:
  build-test:
    docker:
      - image: circleci/node:10
    steps:
      - checkout_and_restore_cache
      - run: npm install --no-package-lock
      - lerna_bootstrap
      - save_cache:
          key: v1-dependencies-{{ checksum "package.json" }}
          paths:
            - ./node_modules
      - run_lerna_test
  test_pipenv-pipfile:
    docker:
      - image: node:<< parameters.node_version >>
    parameters:
      node_version:
        type: string
      pipenv_version:
        type: string
      python_version:
        type: string
    steps:
      - checkout_and_restore_cache
      - run: npm install --no-package-lock
      - lerna_bootstrap
      - run_test:
          package-name: "@snyk-fix/pipenv-pipfile"
          python_version: << parameters.python_version >>
          pipenv_version: << parameters.pipenv_version >>
workflows:
  version: 2
  build-test:
    jobs:
      - build-test:
          context: nodejs-lib-release
          filters:
            branches:
              ignore:
                - master
                - /pull\/[0-9]+/
      - test_pipenv-pipfile:
          name: Node << matrix.node_version >> | Python << matrix.python_version >> | Pip << matrix.pipenv_version >>
          matrix:
            parameters:
              node_version: ['10','12', '14']
              pipenv_version: ['2020.11.4', '2020.8.13']
              python_version: ['2.7']
          filters:
            branches:
              ignore: /.*/
            tags:
              only:
                - /test_@snyk-fix\/pipenv-pipfile.*/
